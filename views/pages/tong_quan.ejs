<%- include ../layouts/header.ejs %>
    <% if (user) { %>
        <!-- Begin page -->
        <div id="layout-wrapper">
            <header id="page-topbar">
                <div class="layout-width">
                    <%- include ../layouts/menu.ejs %>
                </div>
            </header>
            <!-- ========== App Menu ========== -->
            <%- include ../layouts/nav.ejs %>
                <!-- Left Sidebar End -->
                <!-- Vertical Overlay-->
                <div class="vertical-overlay"></div>

                <!-- ============================================================== -->
                <!-- Start right Content here -->
                <!-- ============================================================== -->
                <div class="main-content">

                    <div class="page-content">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-xxl-5">
                                    <div class="d-flex flex-column h-100">
                                        <div class="row h-100">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-body p-0">
                                                        <div class="alert alert-warning border-0 rounded-0 m-0 d-flex align-items-center"
                                                            role="alert">
                                                            <i data-feather="alert-triangle"
                                                                class="text-warning me-2 icon-sm"></i>
                                                            <div class="flex-grow-1 text-truncate">
                                                                CẢNH BÁO GIẢ MẠO
                                                            </div>
                                                        </div>

                                                        <div class="row align-items-end">
                                                            <div class="col-sm-12">
                                                                <div class="p-3">
                                                                    <p class="fs-16 lh-base">Công ty cổ phần Tập đoàn
                                                                        Chợ Toàn Cầu Thông báo: Cảnh giác với những
                                                                        website và các trang mạng xã hội như FB, Tiktok,
                                                                        youtube... giả mạo thương hiệu </p>
                                                                    <div class="flex-shrink-0">
                                                                        <a href="https://chotoancau.vn/tin-hoat-dong/thong-bao-canh-giac-gia-mao-thuong-hieu-43.html"
                                                                            class="text-reset text-decoration-underline"><b>Xem
                                                                                thêm</b></a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div> <!-- end card-body-->
                                                </div>
                                            </div> <!-- end col-->
                                        </div> <!-- end row-->
                                        <div class="row h-100">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-body p-0">
                                                        <div class="alert alert-success border-0 rounded-0 m-0 d-flex align-items-center"
                                                            role="alert">
                                                            <i data-feather="alert-triangle"
                                                                class="text-success me-2 icon-sm"></i>
                                                            <div class="flex-grow-1 text-truncate">
                                                                THÔNG BÁO SỰ KIỆN
                                                            </div>
                                                        </div>

                                                        <div class="row align-items-end">
                                                            <div class="col-sm-12">
                                                                <div class="p-3">
                                                                    <p class="fs-16 lh-base">Công ty cổ phần Tập đoàn
                                                                        Chợ Toàn Cầu Thông báo: Cảnh giác với những
                                                                        website và các trang mạng xã hội như FB, Tiktok,
                                                                        youtube... giả mạo thương hiệu </p>
                                                                    <div class="flex-shrink-0">
                                                                        <a href="https://chotoancau.vn/tin-hoat-dong/thong-bao-canh-giac-gia-mao-thuong-hieu-43.html"
                                                                            class="text-reset text-decoration-underline"><b>Xem
                                                                                thêm</b></a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div> <!-- end card-body-->
                                                </div>
                                            </div> <!-- end col-->
                                        </div> <!-- end row-->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card card-animate">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between">
                                                            <div>
                                                                <p class="fw-medium text-muted mb-0">Tiền đầu tư</p>
                                                                <% let total=0; %>
                                                                    <% hop_dongs.forEach(hop_dong=> { %>
                                                                        <% if ( hop_dong.khach_hang.id===user.id) { %>
                                                                            <% total +=hop_dong.so_tien_dau_tu %>
                                                                                <% } %>
                                                                                    <% }); %>
                                                                                        <h2
                                                                                            class="mt-4 ff-secondary fw-semibold">
                                                                                            <span class="counter-value"
                                                                                                data-target="<%= total %>">0</span>đ
                                                                                        </h2>
                                                                                        <p class="mb-0 text-muted"><span
                                                                                                class="badge bg-light text-success mb-0">
                                                                                                Tổng đầu tư </span></p>
                                                            </div>
                                                            <div>
                                                                <div class="avatar-sm flex-shrink-0">
                                                                    <span
                                                                        class="avatar-title bg-soft-info rounded-circle fs-2">
                                                                        <i data-feather="users" class="text-info"></i>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div><!-- end card body -->
                                                </div> <!-- end card-->
                                            </div> <!-- end col-->

                                            <div class="col-md-6">
                                                <div class="card card-animate">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between">
                                                            <div>
                                                                <% let total_ocss=0; %>
                                                                    <% hop_dongs.forEach(function(hop_dong){ %>
                                                                        <% if ( hop_dong.khach_hang.id===user.id) { %>
                                                                            <% total_ocss +=hop_dong.tien_ocopshop %>
                                                                                <% } %>
                                                                                    <% }); %>
                                                                                        <p
                                                                                            class="fw-medium text-muted mb-0">
                                                                                            Tiền OCS</p>
                                                                                        <h2
                                                                                            class="mt-4 ff-secondary fw-semibold">
                                                                                            <span class="counter-value"
                                                                                                data-target="<%= total_ocss %>">0</span>đ
                                                                                        </h2>
                                                                                        <p class="mb-0 text-muted"><span
                                                                                                class="badge bg-light text-success mb-0">
                                                                                                Tiền thưởng ocopshop
                                                                                            </span></p>
                                                            </div>
                                                            <div>
                                                                <div class="avatar-sm flex-shrink-0">
                                                                    <span
                                                                        class="avatar-title bg-soft-info rounded-circle fs-2">
                                                                        <i data-feather="activity"
                                                                            class="text-info"></i>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div><!-- end card body -->
                                                </div> <!-- end card-->
                                            </div> <!-- end col-->
                                        </div> <!-- end row-->
                                    </div>
                                </div> <!-- end col-->

                                <div class="col-xxl-7">
                                    <div class="row h-100">
                                        <div class="col-xl-6">
                                            <div class="card card-height-100">
                                                <div class="card-header align-items-center d-flex">
                                                    <h4 class="card-title mb-0 flex-grow-1">CHAT ROOM</h4>
                                                </div><!-- end card header -->

                                                <!-- card body -->
                                                <div class="card-body">
                                                    <ul id="messages" style="height: 400px; border: solid 1px #cecece;">
                                                    </ul>
                                                    <div class="chat-input-section">

                                                        <form id="chatinput-form" action="">
                                                            <div class="row g-0 align-items-center">
                                                                <div class="col-auto">
                                                                    <div class="chat-input-links me-2">
                                                                        <div class="links-list-item">
                                                                            <button type="button" class="btn btn-link text-decoration-none emoji-btn" id="emoji-btn">
                                                                                <i class="bx bx-smile align-middle" style="color: rgb(36, 140, 232);"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
            
                                                                <div class="col">
                                                                    <div class="chat-input-feedback">
                                                                        Please Enter a Message
                                                                    </div>
                                                                    <input type="text" class="form-control chat-input bg-light border-light" id="chat-input" placeholder="Type your message..." autocomplete="off">
                                                                </div>
                                                                <div class="col-auto">
                                                                    <div class="chat-input-links ms-2">
                                                                        <div class="links-list-item">
                                                                            <button type="submit" class="btn btn-success chat-send waves-effect waves-light">
                                                                                <i class="ri-send-plane-2-fill align-bottom"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
            
                                                            </div>
                                                            <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.6/socket.io.min.js"></script>
                                                            <script>
                                                            var socket = io();

                                                            var messages = document.getElementById('messages');
                                                            var form = document.getElementById('chatinput-form');
                                                            var input = document.getElementById('chat-input');

                                                            form.addEventListener('submit', function(e) {
                                                                e.preventDefault();
                                                                if (input.value) {
                                                                socket.emit('chat message', input.value);
                                                                input.value = '';
                                                                }
                                                            });

                                                            socket.on('chat message', function(msg) {
                                                                var item = document.createElement('li');
                                                                item.textContent = msg;
                                                                messages.appendChild(item);
                                                                window.scrollTo(0, document.body.scrollHeight);
                                                            });
                                                            </script>
                                                        </form>
                                                    </div>
                                                </div>
                                                <!-- end card body -->
                                            </div><!-- end card -->
                                        </div><!-- end col -->

                                        <div class="col-xl-6">
                                            <div class="card card-height-100">
                                                <div class="card-header align-items-center d-flex">
                                                    <h4 class="card-title mb-0 flex-grow-1">DANH SÁCH DỰ ÁN </h4>
                                                </div>
                                                <div class="card-body p-0">

                                                </div><!-- end card body -->
                                            </div><!-- end card -->
                                        </div> <!-- end col-->

                                    </div> <!-- end row-->
                                </div><!-- end col -->
                            </div>
                            <div class="row">
                                <div class="col-xl-12 col-md-12">
                                    <!-- card -->
                                    <div class="card card-animate">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1 overflow-hidden">
                                                    <p class="text-uppercase fw-medium text-muted text-truncate mb-0">
                                                        Danh sách hợp đồng</p>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-end justify-content-between mt-4">
                                                <div class="table-responsive table-card" style="width: 103%;">
                                                    <table
                                                        class="table table-borderless table-centered align-middle table-nowrap mb-0">
                                                        <thead class="text-muted table-light">
                                                            <tr>
                                                                <th>STT</th>
                                                                <th scope="col">Mã HĐ</th>
                                                                <th scope="col">Khách hàng</th>
                                                                <th scope="col">Tiền ầu tư</th>
                                                                <th scope="col">Thời hạn</th>
                                                                <th scope="col">Ngày ký</th>
                                                                <th scope="col">Tiền thưởng OCS</th>
                                                                <th scope="col">Ngày hết hạn</th>
                                                                <th scope="col">Lãi hàng tháng</th>
                                                                <th scope="col">Trạng thái</th>
                                                                <th scope="col"></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="myTable" style="font-size: 16px;">
                                                            <% var index=0 %>
                                                                <% const thang=new Date(); %>
                                                                    <% const month=thang.getMonth() + 1; %>
                                                                        <% thang.setMonth(month, 0); %>
                                                                            <% const ngay_trong_thang=thang.getDate();
                                                                                %>
                                                                                <% const ngay_het=thang.getDate() - 1 %>
                                                                                    <% hop_dongs.forEach(function(hop_dong){
                                                                                        index++ %>
                                                                                        <% if (
                                                                                            hop_dong.khach_hang.id===user.id)
                                                                                            { %>
                                                                                            <tr>
                                                                                                <td
                                                                                                    style="text-align: center;">
                                                                                                    <%= index %>
                                                                                                </td>
                                                                                                <td>
                                                                                                    <%= hop_dong.ma_hop_dong
                                                                                                        %>
                                                                                                </td>
                                                                                                <td>
                                                                                                    <%= hop_dong.khach_hang.ho_va_ten
                                                                                                        %>
                                                                                                </td>
                                                                                                <td>
                                                                                                    <%= hop_dong.so_tien_dau_tu.toLocaleString();
                                                                                                        %> đ
                                                                                                </td>
                                                                                                <td>
                                                                                                    <%= hop_dong.thoi_han_dau_tu
                                                                                                        %> tháng
                                                                                                </td>

                                                                                                <td>
                                                                                                    <%= hop_dong.ngay_ky_hop_dong.getDate()
                                                                                                        %>/<%=
                                                                                                            hop_dong.ngay_ky_hop_dong.getMonth()
                                                                                                            + 1 %>/<%=
                                                                                                                hop_dong.ngay_ky_hop_dong.getFullYear()
                                                                                                                %>
                                                                                                </td>
                                                                                                <td>
                                                                                                    <%= hop_dong.tien_ocopshop.toLocaleString();
                                                                                                        %> đ
                                                                                                </td>
                                                                                                <td>
                                                                                                    <%= hop_dong.ngay_ky_hop_dong.getDate()
                                                                                                        - 1 %>/<%=
                                                                                                            hop_dong.ngay_ky_hop_dong.getMonth()
                                                                                                            + 1 %>/<%=
                                                                                                                hop_dong.ngay_ky_hop_dong.getFullYear()
                                                                                                                +
                                                                                                                (hop_dong.thoi_han_dau_tu/12)
                                                                                                                %>
                                                                                                </td>
                                                                                                <% if
                                                                                                    ((hop_dong.ngay_ky_hop_dong.getMonth()
                                                                                                    + 1)==month) { %>
                                                                                                    <td
                                                                                                        style="color: rgb(57, 78, 239); font-weight: 600;">
                                                                                                        <span
                                                                                                            class="counter-value"
                                                                                                            data-target="<%= hop_dong.loi_nhuan.thang_dau.toFixed(0) %>">0</span>
                                                                                                        đ
                                                                                                    </td>
                                                                                                    <% } %>
                                                                                                        <% if
                                                                                                            ((hop_dong.ngay_ky_hop_dong.getMonth()
                                                                                                            + 1)
                                                                                                            !=month) {
                                                                                                            %>
                                                                                                            <td
                                                                                                                style="color: rgb(57, 78, 239); font-weight: 600;">
                                                                                                                <%= hop_dong.loi_nhuan.thang.toLocaleString()
                                                                                                                    %> đ
                                                                                                            </td>
                                                                                                            <% } %>
                                                                                                                <td
                                                                                                                    style="color: green; font-weight: 600;">
                                                                                                                    <%= hop_dong.trang_thai.ten_trang_thai
                                                                                                                        %>
                                                                                                                </td>
                                                                                                                <!-- <td>
                                                                  <button type="submit" class="btn btn-soft-success" ><i class="ri-add-circle-line align-middle me-1"></i> Xem hợp đồng</button>
                                                                </td> -->
                                                                                            </tr>
                                                                                            <% } %>
                                                                                                <% }); %>

                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div><!-- end card body -->
                                    </div><!-- end card -->
                                </div><!-- end col -->
                            </div>
                        </div>
                        <!-- container-fluid -->
                    </div>
                    <!-- End Page-content -->
                    <footer class="footer">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-sm-6">
                                    <script>document.write(new Date().getFullYear())</script>© Bản quyền thuộc về công
                                    ty cổ phần tập đoàn chợ toàn cầu.
                                </div>
                                <div class="col-sm-6">
                                    <div class="text-sm-end d-none d-sm-block">
                                        Design & Develop by Lê Tuấn Khang
                                    </div>
                                </div>
                            </div>
                        </div>
                    </footer>
                </div>
                <!-- end main content-->

        </div>
        <!-- END layout-wrapper -->



        <!--start back-to-top-->
        <button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
            <i class="ri-arrow-up-line"></i>
        </button>
        <!--end back-to-top-->

        <div class="customizer-setting d-none d-md-block">
            <div class="btn-info btn-rounded shadow-lg btn btn-icon btn-lg p-2" data-bs-toggle="offcanvas"
                data-bs-target="#theme-settings-offcanvas" aria-controls="theme-settings-offcanvas">
                <i class='mdi mdi-spin mdi-cog-outline fs-22'></i>
            </div>
        </div>
        <% } %>
            <%- include ../layouts/footer.ejs %>